# 服务端多链逻辑说明

## 背景

融云提供全球链路功能，实现全球网络的互链互通。目前全网实现了链路优化功能，SDK 连接时先链接 AP 点，再链接所属数据中心。


## 移动端多链接方式说明

SDK 请求链接时，融云 Server 端判断请求应该为直接连数据中心，还是通过 AP 点连接数据中心，在这两种连接方式的基础上。

从 SDK 2.8.0 及以后版本开始支持多链路功能，目前 SDK 链接 IM Server 的方式分为以下 3 种：

** 1、SDK 直链方式 **

SDK 直接连接所属数据中心，Server 端向 SDK 下发可连接的链路列表，包括：

* 直连数据中心 IP 地址 + 标准端口
* 直连数据中心 IP 地址 + 非标准端口
* IDC AP 地址，此链路需要在服务端进行配置后才能下发给 SDK ，配置维度为数据中心级别。

IDC AP 为数据中心维度为 AP 点。

注：目前 SDK 尝试连接 IM Server 所使用的地址以 Server 端下发的顺序为准。如某一地址链接成功后不再进行尝试。

** 2、AP 连接方式 **

SDK 先连接到所属 AP 点，再通过 AP 点连接到数据中心，Server 端向 SDK 下发可连接的链路列表，包括：

* AP 点 IP 地址 + 非标准端口
* 直连数据中心 IP 地址 + 标准端口
* 直连数据中心 IP 地址 + 非标准端口

注：针对高成本的 AP 点，Server 会调整连接列表中链路的顺序，先走直链标准、AP 、直链非标准，如：在台湾访问美国数据中心，直连和 AP 点性能相差不大，Server 配置后下发给 SDK 链路列表的顺序为：

1. 直连数据中心 IP 地址 + 标准端口
2. AP 点 IP 地址 + 非标准端口
3. 直连数据中心 IP 地址 + 非标准端口

** 3、多 AP 连接方式 **

链路不稳定的地区会配置两个 AP 点（如：迪拜 CDS、AL）进行互备，Server 端会向 SDK 下发多个 AP 点链接地址进行尝试，如下：

* AP 点1 IP 地址 + 非标准端口
* AP 点2 IP 地址 + 非标准端口
* 直连数据中心 IP 地址 + 标准端口
* 直连数据中心 IP 地址 + 非标准端口

注：多个 AP 点间的互备策略是在 Server 端进行配置，原则是基于地理位置及供应商，默认配置为基于数据中心，可进行 APP 级别的独立配置。APP 级配置高于数据中心级配置。

** APP 级别基于第三方链路加速 **

需要商务沟通，单独购买属于应用专属链路能力。

该链路配置是基于 APP 的单独配置。开通后在以上 3 种连接方式中都可以使用，可配置为首选链路或未选链路。

** 数据中心级别第三方链路加速 **

该种链接只针对于直链数据中心链路生效，此链路需要 Server 端进行配置，配置后才会下发 SDK 。

例：国内数据中心，所有直链数据中心的链路都会下发网速链路。

```
tcpproxy-cn.ronghub.com:443,tcpproxy-cn.ronghub.com:8100
```

**应用专属 AP 能力**

基础 AP 会承接所属数据中心所有的流量接入，专属 AP 只针对指定 APP 接入，需要独立部署。如：中国数据中心，法兰克服 AP 点会承载所有 APP 下所有欧州用户连接中国数据中心的流量，如客户 A 部署了专属 AP 点流量为 10 万，只有客户A 走专属 AP 点，其他客户的流量不会走此 AP 点。

## Web 端多链接方式说明

目前 Web 端支持 WebSocket 和 Comet 两种连接方式，Web SDK 2.3.1 及以上版本支持多链逻辑。

** 1、WebSocket **

WebSocket 目前不支持 CDN APPA 连接方式其他（SDK 直连、AP 连接、多 AP 连接）方式都支持，与移动端逻辑一致。

注：https 不支持多链连接方式

** 2、Comet **

Comet 目前仅支持`直连数据中心 IP 地址 + 非标准端口`的方式，其他链接方式都不支持。

注：https 不支持多链连接方式

## SDK 连接逻辑

**历史版本**

根据 Server 提供的链路列表，以串行方式进行连接。

问题：

1. 串行连接，连接缓慢。先尝试链路1、链路2、链路3，连接不成功后再进行重新尝试。
2. 重连逻辑，连接成功断网后再次重连时，还是从链路1重新尝试链接，存在无意义的重试，未智能选择最优连接方式。
3. 效率低，用户体验差，业务失败率高问题。

**优化版本**

实现复合连接功能，对 Server 端提供的链路列表，进行并行方式连接，先尝试从链路1开始连接，如连不上，会并行连接其他链路，哪条链路最先连上先用谁，并断开其他链接尝试。

此版本从 SDK 2.8.28 版本开始支持，默认为关闭状态，需要 Server 端配置后才能开启使用。

**待优化功能**

1. 重连逻辑优化
2. 客户端日志上报功能优化